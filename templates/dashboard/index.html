{% extends "base.html" %}

{% block title %}Tableau de bord - Gestion des Ch√®ques{% endblock %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-tachometer-alt me-2"></i>Tableau de bord</h1>
    <div class="d-flex align-items-center">
        <select id="languageSelect" class="form-select me-3" style="width: auto;">
            <option value="fr">Fran√ßais</option>
            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        </select>
        <small class="text-muted">{{ moment().format('dddd, MMMM Do YYYY') if moment else '' }}</small>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title" data-fr="En Attente" data-ar="ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±">En Attente</h6>
                        <h3 class="mb-0">{{ status_stats.get('EN ATTENTE', 0) }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title" data-fr="Encaiss√©s" data-ar="ŸÖÿ≠ÿµŸÑÿ©">Encaiss√©s</h6>
                        <h3 class="mb-0">{{ status_stats.get('ENCAISS√â', 0) }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title" data-fr="Impay√©s" data-ar="ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπÿ©">Impay√©s</h6>
                        <h3 class="mb-0">{{ status_stats.get('IMPAY√â', 0) }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Statistics -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Montant Encaiss√© ce Mois</h5>
                <h3 class="text-success">{{ "{:,.2f}".format(monthly_amount) }} MAD</h3>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Ch√®ques en Retard</h5>
                <h3 class="text-danger">{{ overdue_cheques }}</h3>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">√Ä √âch√©ance (3 jours)</h5>
                <h3 class="text-warning">{{ due_soon }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Status Distribution Chart -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0" data-fr="üìä R√©partition des Statuts" data-ar="üìä ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™">üìä R√©partition des Statuts</h5>
            </div>
            <div class="card-body">
                <div id="statusChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Monthly Evolution Chart -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0" data-fr="üìà √âvolution mensuelle des encaissements" data-ar="üìà ÿßŸÑÿ™ÿ∑Ÿàÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä ŸÑŸÑÿ™ÿ≠ÿµŸäŸÑÿßÿ™">üìà √âvolution mensuelle des encaissements</h5>
            </div>
            <div class="card-body">
                <canvas id="monthlyChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Top Clients and Bank Analysis -->
<div class="row mb-4">
    <!-- Top Clients by Amount -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0" data-fr="üí∞ Top 5 Clients par Montant" data-ar="üí∞ ÿ£ŸÅÿ∂ŸÑ 5 ÿπŸÖŸÑÿßÿ° ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ®ŸÑÿ∫">üí∞ Top 5 Clients par Montant</h5>
            </div>
            <div class="card-body">
                <canvas id="topClientsChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Bank Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0" data-fr="üè¶ Nombre de ch√®ques par banque" data-ar="üè¶ ÿπÿØÿØ ÿßŸÑÿ¥ŸäŸÉÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ŸÜŸÉ">üè¶ Nombre de ch√®ques par banque</h5>
            </div>
            <div class="card-body">
                <div id="bankChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Risk Clients Alert -->
{% if risk_clients %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0" data-fr="‚ö†Ô∏è Clients √† risque" data-ar="‚ö†Ô∏è ÿπŸÖŸÑÿßÿ° ŸÅŸä ÿÆÿ∑ÿ±">‚ö†Ô∏è Clients √† risque</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3" data-fr="Clients ayant ‚â• 2 ch√®ques impay√©s" data-ar="ÿπŸÖŸÑÿßÿ° ŸÑÿØŸäŸáŸÖ ‚â• 2 ÿ¥ŸäŸÉÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπÿ©">Clients ayant ‚â• 2 ch√®ques impay√©s</p>
                <div class="row">
                    {% for client in risk_clients %}
                    <div class="col-md-6 mb-3">
                        <div class="alert alert-danger d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ client.name }}</strong>
                                <br>
                                <small>{{ client.unpaid_count }} ch√®ques impay√©s - {{ "{:,.2f}".format(client.unpaid_amount) }} MAD</small>
                            </div>
                            <a href="{{ url_for('clients.view', id=client.id) }}" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Actions Rapides</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('cheques.new') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Nouveau Ch√®que
                    </a>
                    <a href="{{ url_for('clients.new') }}" class="btn btn-outline-primary">
                        <i class="fas fa-user-plus me-2"></i>Nouveau Client
                    </a>
                    <a href="{{ url_for('exports.index') }}" class="btn btn-outline-success">
                        <i class="fas fa-download me-2"></i>Exporter des Donn√©es
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Cheques -->
{% if recent_cheques %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Ch√®ques R√©cents</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>N¬∞ Ch√®que</th>
                        <th>Client</th>
                        <th>Banque</th>
                        <th>Montant</th>
                        <th>√âch√©ance</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cheque in recent_cheques %}
                    <tr>
                        <td>{{ cheque.cheque_number or 'N/A' }}</td>
                        <td>{{ cheque.client.name }}</td>
                        <td>{{ cheque.branch.bank.name }}</td>
                        <td>{{ "{:,.2f}".format(cheque.amount) }} {{ cheque.currency }}</td>
                        <td>
                            {{ cheque.due_date.strftime('%d/%m/%Y') }}
                            {% if cheque.is_overdue %}
                                <i class="fas fa-exclamation-triangle text-danger ms-1" title="En retard"></i>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ cheque.status_color }}">
                                {{ cheque.status_text }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="text-center">
            <a href="{{ url_for('cheques.index') }}" class="btn btn-outline-primary">
                Voir tous les ch√®ques <i class="fas fa-arrow-right ms-1"></i>
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Language switching
    const languageSelect = document.getElementById('languageSelect');
    let currentLanguage = 'fr';
    
    if (languageSelect) {
        languageSelect.addEventListener('change', function() {
            currentLanguage = this.value;
            updateLanguage();
        });
    }
    
    function updateLanguage() {
        const elements = document.querySelectorAll('[data-fr][data-ar]');
        elements.forEach(element => {
            if (currentLanguage === 'ar') {
                element.textContent = element.getAttribute('data-ar');
                element.style.direction = 'rtl';
            } else {
                element.textContent = element.getAttribute('data-fr');
                element.style.direction = 'ltr';
            }
        });
    }
    
    // Status Distribution Donut Chart (Plotly)
    if (typeof Plotly !== 'undefined' && document.getElementById('statusChart')) {
        const statusData = [{
            values: [{{ status_stats.get('EN ATTENTE', 0) }}, {{ status_stats.get('ENCAISS√â', 0) }}, {{ status_stats.get('IMPAY√â', 0) }}],
            labels: ['EN ATTENTE', 'ENCAISS√â', 'IMPAY√â'],
            type: 'pie',
            hole: 0.4,
            marker: {
                colors: ['#0d6efd', '#198754', '#ffc107']
            },
            textinfo: 'label+percent',
            textposition: 'outside'
        }];
        
        const statusLayout = {
            title: '',
            showlegend: true,
            height: 400,
            margin: { t: 30, b: 30, l: 30, r: 30 }
        };
        
        Plotly.newPlot('statusChart', statusData, statusLayout, {responsive: true});
    }
    
    // Monthly Evolution Chart (Chart.js)
    if (typeof Chart !== 'undefined') {
        const monthlyCtx = document.getElementById('monthlyChart');
        if (monthlyCtx) {
            new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: {{ monthly_labels | safe }},
                    datasets: [{
                        label: 'Montant Encaiss√© (MAD)',
                        data: {{ monthly_amounts | safe }},
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' MAD';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString() + ' MAD';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Top Clients Chart (Chart.js)
        const topClientsCtx = document.getElementById('topClientsChart');
        if (topClientsCtx) {
            new Chart(topClientsCtx, {
                type: 'bar',
                data: {
                    labels: {{ top_clients_names | safe }},
                    datasets: [{
                        label: 'Montant (MAD)',
                        data: {{ top_clients_amounts | safe }},
                        backgroundColor: 'rgba(13, 110, 253, 0.8)',
                        borderColor: '#0d6efd',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' MAD';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.x.toLocaleString() + ' MAD';
                                }
                            }
                        }
                    }
                }
            });
        }
    }
    
    // Bank Distribution Chart (Plotly)
    if (typeof Plotly !== 'undefined' && document.getElementById('bankChart')) {
        const bankData = [{
            values: {{ bank_cheque_counts | safe }},
            labels: {{ bank_names | safe }},
            type: 'pie',
            marker: {
                colors: ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c']
            },
            textinfo: 'label+percent',
            textposition: 'outside'
        }];
        
        const bankLayout = {
            title: '',
            showlegend: true,
            height: 300,
            margin: { t: 30, b: 30, l: 30, r: 30 }
        };
        
        Plotly.newPlot('bankChart', bankData, bankLayout, {responsive: true});
    }
    
    // Status Filter for Recent Cheques
    const statusFilter = document.getElementById('statusFilter');
    const tableRows = document.querySelectorAll('#recentChequesTable tr');
    
    if (statusFilter && tableRows.length > 0) {
        statusFilter.addEventListener('change', function() {
            const selectedStatus = this.value;
            
            tableRows.forEach(row => {
                const rowStatus = row.getAttribute('data-status');
                if (selectedStatus === '' || rowStatus === selectedStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
});
</script>
{% endblock %}
