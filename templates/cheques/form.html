{% extends "base.html" %}

{% block title %}{{ title }} - Gestion des Chèques{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-money-check me-2"></i>{{ title }}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="chequeForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <!-- Amount and Currency -->
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        {{ form.amount.label(class="form-label") }}
                                        {{ form.amount(class="form-control", step="0.01") }}
                                        {% if form.amount.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.amount.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ form.currency.label(class="form-label") }}
                                        {{ form.currency(class="form-select") }}
                                        {% if form.currency.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.currency.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dates -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.issue_date.label(class="form-label") }}
                                        {{ form.issue_date(class="form-control") }}
                                        {% if form.issue_date.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.issue_date.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.due_date.label(class="form-label") }}
                                        {{ form.due_date(class="form-control") }}
                                        {% if form.due_date.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.due_date.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Client Selection with Autocomplete -->
                            <div class="mb-3">
                                {{ form.client_id.label(class="form-label") }}
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="clientSearch" 
                                           placeholder="Commencer à taper pour rechercher un client..."
                                           autocomplete="off">
                                    {{ form.client_id(style="display: none;") }}
                                    <div id="clientSuggestions" class="dropdown-menu w-100" style="display: none;"></div>
                                </div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#newClientModal">
                                        <i class="fas fa-user-plus me-1"></i>Nouveau Client
                                    </button>
                                </div>
                                {% if form.client_id.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.client_id.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Bank/Branch Selection -->
                            <div class="mb-3">
                                {{ form.branch_id.label(class="form-label") }}
                                {{ form.branch_id(class="form-select") }}
                                {% if form.branch_id.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.branch_id.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="col-md-6">
                            <!-- Payment Type -->
                            <div class="mb-3">
                                {{ form.payment_type.label(class="form-label") }}
                                {{ form.payment_type(class="form-select") }}
                                {% if form.payment_type.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.payment_type.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Created Date -->
                            <div class="mb-3">
                                {{ form.created_date.label(class="form-label") }}
                                {{ form.created_date(class="form-control") }}
                                {% if form.created_date.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.created_date.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Status -->
                            <div class="mb-3">
                                {{ form.status.label(class="form-label") }}
                                {{ form.status(class="form-select", id="status") }}
                                {% if form.status.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.status.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Unpaid Reason (show only if status is IMPAYÉ) -->
                            <div class="mb-3" id="unpaid-reason-div" style="display: none;">
                                {{ form.unpaid_reason.label(class="form-label") }}
                                {{ form.unpaid_reason(class="form-control", rows="3") }}
                                {% if form.unpaid_reason.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.unpaid_reason.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Cheque Number -->
                            <div class="mb-3">
                                {{ form.cheque_number.label(class="form-label") }}
                                {{ form.cheque_number(class="form-control") }}
                                {% if form.cheque_number.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.cheque_number.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Depositor Name -->
                            <div class="mb-3">
                                {{ form.depositor_name.label(class="form-label") }}
                                {{ form.depositor_name(class="form-control") }}
                                {% if form.depositor_name.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.depositor_name.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Invoice Info -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.invoice_number.label(class="form-label") }}
                                        {{ form.invoice_number(class="form-control") }}
                                        {% if form.invoice_number.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.invoice_number.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.invoice_date.label(class="form-label") }}
                                        {{ form.invoice_date(class="form-control") }}
                                        {% if form.invoice_date.errors %}
                                            <div class="text-danger small mt-1">
                                                {% for error in form.invoice_date.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- File Upload -->
                            <div class="mb-3">
                                {{ form.scan.label(class="form-label") }}
                                {{ form.scan(class="form-control") }}
                                {% if form.scan.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.scan.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Formats acceptés: JPG, PNG, PDF (Max: 16MB)</div>
                                {% if cheque is defined and cheque.scan_path %}
                                <div class="mt-2">
                                    <a href="{{ url_for('static', filename='uploads/' + cheque.scan_path) }}" 
                                       target="_blank" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-eye me-1"></i>Voir le scan actuel
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="mb-3">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control", rows="3") }}
                        {% if form.notes.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.notes.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('cheques.index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Retour
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- New Client Modal -->
<div class="modal fade" id="newClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nouveau Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newClientForm">
                    <div class="mb-3">
                        <label class="form-label">Type de client</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="type" id="typePersonne" value="personne" checked>
                                <label class="form-check-label" for="typePersonne">Personne physique</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="type" id="typeEntreprise" value="entreprise">
                                <label class="form-check-label" for="typeEntreprise">Entreprise</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="clientName" class="form-label" id="clientNameLabel">Nom et prénom</label>
                        <input type="text" class="form-control" id="clientName" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="clientIdNumber" class="form-label" id="clientIdLabel">CIN</label>
                        <input type="text" class="form-control" id="clientIdNumber" name="id_number">
                    </div>
                    
                    <div class="mb-3">
                        <label for="clientVatNumber" class="form-label" id="clientVatLabel">IF</label>
                        <input type="text" class="form-control" id="clientVatNumber" name="vat_number">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="saveClientBtn">Créer Client</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Client autocomplete
    let clientTimeout;
    $('#clientSearch').on('input', function() {
        const query = $(this).val();
        
        clearTimeout(clientTimeout);
        
        if (query.length < 2) {
            $('#clientSuggestions').hide();
            return;
        }
        
        clientTimeout = setTimeout(function() {
            $.get('{{ url_for("clients.api_search") }}', { q: query })
                .done(function(data) {
                    const suggestions = $('#clientSuggestions');
                    suggestions.empty();
                    
                    if (data.length > 0) {
                        data.forEach(function(client) {
                            const item = $(`
                                <a class="dropdown-item client-suggestion" href="#" data-id="${client.id}">
                                    <div>
                                        <strong>${client.name}</strong>
                                        <br>
                                        <small class="text-muted">
                                            ${client.type === 'personne' ? 'Personne' : 'Entreprise'}
                                            ${client.id_number ? ' - ' + client.id_number : ''}
                                        </small>
                                    </div>
                                </a>
                            `);
                            suggestions.append(item);
                        });
                        suggestions.show();
                    } else {
                        suggestions.hide();
                    }
                });
        }, 300);
    });
    
    // Handle client selection
    $(document).on('click', '.client-suggestion', function(e) {
        e.preventDefault();
        const clientId = $(this).data('id');
        const clientName = $(this).find('strong').text();
        
        $('#client_id').val(clientId);
        $('#clientSearch').val(clientName);
        $('#clientSuggestions').hide();
    });
    
    // Hide suggestions when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#clientSearch, #clientSuggestions').length) {
            $('#clientSuggestions').hide();
        }
    });
    
    // New client modal type change
    $('input[name="type"]').change(function() {
        const type = $(this).val();
        if (type === 'personne') {
            $('#clientNameLabel').text('Nom et prénom');
            $('#clientIdLabel').text('CIN');
            $('#clientVatLabel').text('IF');
        } else {
            $('#clientNameLabel').text('Raison sociale');
            $('#clientIdLabel').text('RC');
            $('#clientVatLabel').text('ICE');
        }
    });
    
    // Save new client
    $('#saveClientBtn').click(function() {
        const formData = {
            type: $('input[name="type"]:checked').val(),
            name: $('#clientName').val(),
            id_number: $('#clientIdNumber').val(),
            vat_number: $('#clientVatNumber').val()
        };
        
        if (!formData.name) {
            alert('Le nom est requis');
            return;
        }
        
        $.ajax({
            url: '{{ url_for("clients.api_create") }}',
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': $('input[name="csrf_token"]').val()
            },
            data: JSON.stringify(formData)
        })
        .done(function(data) {
            // Add to form
            const option = $('<option>', {
                value: data.id,
                text: data.name,
                selected: true
            });
            $('#client_id').append(option);
            $('#clientSearch').val(data.name);
            
            // Close modal and reset form
            $('#newClientModal').modal('hide');
            $('#newClientForm')[0].reset();
            $('input[name="type"][value="personne"]').prop('checked', true);
            
            alert('Client créé avec succès!');
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Erreur lors de la création du client';
            alert(error);
        });
    });
    
    // Set default dates
    if (!$('#issue_date').val()) {
        $('#issue_date').val(new Date().toISOString().split('T')[0]);
    }
    
    // Preselect client if editing
    {% if cheque is defined %}
    $('#client_id').val({{ cheque.client_id }});
    $('#clientSearch').val('{{ cheque.client.name }}');
    {% endif %}
});
</script>
{% endblock %}
